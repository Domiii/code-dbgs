"use strict";(self.webpackChunkdbux_docs=self.webpackChunkdbux_docs||[]).push([[246],{3905:function(e,n,t){t.d(n,{Zo:function(){return d},kt:function(){return b}});var a=t(7294);function i(e,n,t){return n in e?Object.defineProperty(e,n,{value:t,enumerable:!0,configurable:!0,writable:!0}):e[n]=t,e}function l(e,n){var t=Object.keys(e);if(Object.getOwnPropertySymbols){var a=Object.getOwnPropertySymbols(e);n&&(a=a.filter((function(n){return Object.getOwnPropertyDescriptor(e,n).enumerable}))),t.push.apply(t,a)}return t}function r(e){for(var n=1;n<arguments.length;n++){var t=null!=arguments[n]?arguments[n]:{};n%2?l(Object(t),!0).forEach((function(n){i(e,n,t[n])})):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(t)):l(Object(t)).forEach((function(n){Object.defineProperty(e,n,Object.getOwnPropertyDescriptor(t,n))}))}return e}function o(e,n){if(null==e)return{};var t,a,i=function(e,n){if(null==e)return{};var t,a,i={},l=Object.keys(e);for(a=0;a<l.length;a++)t=l[a],n.indexOf(t)>=0||(i[t]=e[t]);return i}(e,n);if(Object.getOwnPropertySymbols){var l=Object.getOwnPropertySymbols(e);for(a=0;a<l.length;a++)t=l[a],n.indexOf(t)>=0||Object.prototype.propertyIsEnumerable.call(e,t)&&(i[t]=e[t])}return i}var u=a.createContext({}),s=function(e){var n=a.useContext(u),t=n;return e&&(t="function"==typeof e?e(n):r(r({},n),e)),t},d=function(e){var n=s(e.components);return a.createElement(u.Provider,{value:n},e.children)},p={inlineCode:"code",wrapper:function(e){var n=e.children;return a.createElement(a.Fragment,{},n)}},c=a.forwardRef((function(e,n){var t=e.components,i=e.mdxType,l=e.originalType,u=e.parentName,d=o(e,["components","mdxType","originalType","parentName"]),c=s(t),b=i,m=c["".concat(u,".").concat(b)]||c[b]||p[b]||l;return t?a.createElement(m,r(r({ref:n},d),{},{components:t})):a.createElement(m,r({ref:n},d))}));function b(e,n){var t=arguments,i=n&&n.mdxType;if("string"==typeof e||i){var l=t.length,r=new Array(l);r[0]=c;var o={};for(var u in n)hasOwnProperty.call(n,u)&&(o[u]=n[u]);o.originalType=e,o.mdxType="string"==typeof e?e:i,r[1]=o;for(var s=2;s<l;s++)r[s]=t[s];return a.createElement.apply(null,r)}return a.createElement.apply(null,t)}c.displayName="MDXCreateElement"},5002:function(e,n,t){t.d(n,{Z:function(){return s}});var a=t(7462),i=t(3366),l=t(7294),r=t(3616),o=["toc","className","linkClassName","linkActiveClassName","minHeadingLevel","maxHeadingLevel"];function u(e){var n=e.toc,t=e.className,a=e.linkClassName,i=e.isChild;return n.length?l.createElement("ul",{className:i?void 0:t},n.map((function(e){return l.createElement("li",{key:e.id},l.createElement("a",{href:"#"+e.id,className:null!=a?a:void 0,dangerouslySetInnerHTML:{__html:e.value}}),l.createElement(u,{isChild:!0,toc:e.children,className:t,linkClassName:a}))}))):null}function s(e){var n=e.toc,t=e.className,s=void 0===t?"table-of-contents table-of-contents__left-border":t,d=e.linkClassName,p=void 0===d?"table-of-contents__link":d,c=e.linkActiveClassName,b=void 0===c?void 0:c,m=e.minHeadingLevel,k=e.maxHeadingLevel,f=(0,i.Z)(e,o),g=(0,r.LU)(),h=null!=m?m:g.tableOfContents.minHeadingLevel,v=null!=k?k:g.tableOfContents.maxHeadingLevel,w=(0,r.DA)({toc:n,minHeadingLevel:h,maxHeadingLevel:v}),x=(0,l.useMemo)((function(){if(p&&b)return{linkClassName:p,linkActiveClassName:b,minHeadingLevel:h,maxHeadingLevel:v}}),[p,b,h,v]);return(0,r.Si)(x),l.createElement(u,(0,a.Z)({toc:w,className:s,linkClassName:p},f))}},3755:function(e,n,t){t.d(n,{Z:function(){return u}});var a=t(7462),i=t(3366),l=t(7294),r=t(9700),o=["path","children","title"];function u(e){var n=e.path,t=e.children,u=e.title,s=(0,i.Z)(e,o);if(!n)throw new Error('invalid <CodeLink /> missing "path". - props: '+JSON.stringify(e,null,2));var d=(0,r.B)(n);t=t||d,u=u||t;var p="https://github.com/Domiii/dbux/tree/master/"+n;return l.createElement("a",(0,a.Z)({title:u,href:p},s),t)}},8640:function(e,n,t){t.d(n,{Z:function(){return u}});var a=t(7294),i="tableOfContentsInline_0DDH",l=t(5002);var r=function(e){var n=e.toc,t=e.minHeadingLevel,r=e.maxHeadingLevel;return a.createElement("div",{className:i},a.createElement(l.Z,{toc:n,minHeadingLevel:t,maxHeadingLevel:r,className:"table-of-contents",linkClassName:null}))},o={display:"none"};function u(e){var n=e.toc;return a.createElement("div",{style:o},a.createElement(r,{toc:n}))}},5479:function(e,n,t){t.d(n,{Z:function(){return s}});var a=t(7462),i=t(3366),l=t(7294),r=t(9700),o=t(8767),u=["name","children","title"];function s(e){var n=e.name,t=e.children,s=e.title,d=(0,i.Z)(e,u);if(null==n||!n.includes)throw new Error('Invalid ToolLink does not have a "name" of type string. - props: '+JSON.stringify(e,null,2));if(n.includes("/"))throw new Error('ToolLink\'s "name" must not be a path. - props: '+JSON.stringify(e,null,2));if(!n)throw new Error('invalid <ToolLink /> missing "name". - props: '+JSON.stringify(e,null,2));var p=(0,r.B)(n);t=t||p,s=s||p;var c=(0,o.Z)()+"tools-and-configuration/"+n;return l.createElement("a",(0,a.Z)({title:s,href:c},d),t)}},8767:function(e,n,t){t.d(n,{Z:function(){return i}});var a=t(2263);function i(){return(0,a.Z)().siteConfig.baseUrl}},9700:function(e,n,t){t.d(n,{B:function(){return i}});var a={"dbux-code":"Dbux VSCode Extension"};function i(e){var n=a[e];return n||(e.startsWith("dbux-")&&!e.startsWith("dbux-code")?"@dbux/"+e.substring(5):e)}},4771:function(e,n,t){t.r(n),t.d(n,{frontMatter:function(){return d},contentTitle:function(){return p},metadata:function(){return c},toc:function(){return b},default:function(){return k}});var a=t(7462),i=t(3366),l=(t(7294),t(3905)),r=t(5479),o=t(3755),u=t(8640),s=["components"],d={},p="Build Pipeline Integration",c={unversionedId:"guides/build-pipeline-integration",id:"guides/build-pipeline-integration",title:"Build Pipeline Integration",description:'As explained in the "Dynamic Analysis" chapter you need to "babel your program" with @dbux/babel-plugin enabled).',source:"@site/content/guides/03-build-pipeline-integration.mdx",sourceDirName:"guides",slug:"/guides/build-pipeline-integration",permalink:"/dbux/guides/build-pipeline-integration",editUrl:"https://github.com/Domiii/dbux/blob/master/docs/content/guides/03-build-pipeline-integration.mdx",tags:[],version:"current",sidebarPosition:3,frontMatter:{},sidebar:"tutorialSidebar",previous:{title:"Performance",permalink:"/dbux/guides/performance"},next:{title:"Tools and Configuration Overview",permalink:"/dbux/tools-and-configuration"}},b=[{value:"Setup",id:"setup",children:[],level:2},{value:"Config",id:"config",children:[],level:2},{value:"Node Applications",id:"node-applications",children:[],level:2},{value:"Webpack",id:"webpack",children:[{value:"Debugging Webpack w/ Dbux",id:"debugging-webpack-w-dbux",children:[],level:3}],level:2},{value:"Rollup",id:"rollup",children:[],level:2},{value:"Storybook",id:"storybook",children:[],level:2},{value:"Create-React-App",id:"create-react-app",children:[],level:2},{value:"Next.js",id:"nextjs",children:[],level:2},{value:"ng",id:"ng",children:[],level:2},{value:"Other Bundlers or Bundler Wrappers",id:"other-bundlers-or-bundler-wrappers",children:[],level:2}],m={toc:b};function k(e){var n=e.components,t=(0,i.Z)(e,s);return(0,l.kt)("wrapper",(0,a.Z)({},m,t,{components:n,mdxType:"MDXLayout"}),(0,l.kt)("h1",{id:"build-pipeline-integration"},"Build Pipeline Integration"),(0,l.kt)(u.Z,{toc:b,mdxType:"TOC"}),(0,l.kt)("p",null,"As explained in ",(0,l.kt)("a",{parentName:"p",href:"/dbux/dbux-features/enable-dbux"},'the "Dynamic Analysis" chapter'),": for Dbux to work, it first needs to record JavaScript application behavior. To that end, your program must be instrumented with ",(0,l.kt)(o.Z,{path:"dbux-babel-plugin",mdxType:"CodeLink"}),' (i.e.: you need to "',(0,l.kt)("a",{parentName:"p",href:"https://babeljs.io/"},"babel"),' your program" with ',(0,l.kt)("inlineCode",{parentName:"p"},"@dbux/babel-plugin")," enabled)."),(0,l.kt)("p",null,"Once running, the injected ",(0,l.kt)("inlineCode",{parentName:"p"},"@dbux/runtime")," will send collected data to the ",(0,l.kt)("a",{parentName:"p",href:"/dbux/tools-and-configuration/dbux-code#runtime-server"},"runtime server"),"."),(0,l.kt)("h2",{id:"setup"},"Setup"),(0,l.kt)("p",null,"First ",(0,l.kt)("inlineCode",{parentName:"p"},"npm install")," or ",(0,l.kt)("inlineCode",{parentName:"p"},"yarn add")," the necessary ",(0,l.kt)("inlineCode",{parentName:"p"},"@dbux")," packages to the project you want to trace:"),(0,l.kt)("ul",null,(0,l.kt)("li",{parentName:"ul"},(0,l.kt)("inlineCode",{parentName:"li"},"@dbux/babel-plugin")),(0,l.kt)("li",{parentName:"ul"},(0,l.kt)("inlineCode",{parentName:"li"},"@dbux/runtime"))),(0,l.kt)("p",null,"Alternatively, simply install ",(0,l.kt)(r.Z,{name:"dbux-cli",mdxType:"ToolLink"}),". That will also install the other necessary dependencies."),(0,l.kt)("p",null,"Important: Make sure, that they match the version of ",(0,l.kt)(r.Z,{name:"dbux-code",mdxType:"ToolLink"})," that you installed."),(0,l.kt)("h2",{id:"config"},"Config"),(0,l.kt)("p",null,"You can find configuration options for the different tools in the ",(0,l.kt)("a",{parentName:"p",href:"/dbux/tools-and-configuration"},'"Tools and Configuration" chapter'),"."),(0,l.kt)("p",null,"In addition to configuring the individual tools, you want to make sure you ",(0,l.kt)("a",{parentName:"p",href:"/dbux/guides/runtime-trace-filtering"},"configure the module filter to trace the right files"),"."),(0,l.kt)("h2",{id:"node-applications"},"Node Applications"),(0,l.kt)("p",null,"For Node applications that do not need bundling or building, refer to ",(0,l.kt)("a",{parentName:"p",href:"/dbux/tools-and-configuration/dbux-cli"},"the Dbux CLI")," documentation."),(0,l.kt)("h2",{id:"webpack"},"Webpack"),(0,l.kt)("p",null,"Example:"),(0,l.kt)("pre",null,(0,l.kt)("code",{parentName:"pre",className:"language-js"},"const makeInclude = require('@dbux/common-node/dist/filters/makeInclude').default;\n\nconst moduleFilterOptions = {\n  packageWhitelist: 'interestingPackage1,@interesting/package2',\n  // packageBlacklist: '',\n  fileBlacklist: '.*bad_file1\\.js,.*/unwanted_dir1/.*'\n};\n\n// ...\n\nmodule.exports = {\n  // ...\n  module: {\n    rules: [\n      // ...\n      {\n        test: /\\.jsx?$/,\n        include: [\n          makeInclude(moduleFilterOptions)\n        ],\n        use: {\n          loader: 'babel-loader',\n          options: {\n            /**\n             * Make sure, things work correctly, even if babeling (maybe previously unbabled) `node_modules`.\n             * @see https://github.com/webpack/webpack/issues/4039#issuecomment-419284940\n             */\n            sourceType: 'unambiguous',\n            plugins: [\n              // other plugins, running **after** Dbux...\n              '@dbux/babel-plugin'\n              // other plugins, running **before** Dbux...\n            ]\n          }\n        }\n      }\n    ]\n  }\n};\n")),(0,l.kt)("p",null,"NOTE: For ",(0,l.kt)("a",{parentName:"p",href:"/dbux/dbux-practice/"},"Dbux Practice")," projects, we use the (configurable/flexible/complicated) ",(0,l.kt)(o.Z,{path:"dbux-projects/assets/sharedAssets/webpack/dbux.webpack.config.base.js",mdxType:"CodeLink"},"dbux.webpack.config.base.js"),"."),(0,l.kt)("h3",{id:"debugging-webpack-w-dbux"},"Debugging Webpack w/ Dbux"),(0,l.kt)("p",null,"Sometimes, you want to debug your ",(0,l.kt)("inlineCode",{parentName:"p"},"webpack.config.js"),", or ",(0,l.kt)("inlineCode",{parentName:"p"},"webpack"),", in general, using Dbux."),(0,l.kt)("p",null,"This is the command to do that:"),(0,l.kt)("pre",null,(0,l.kt)("code",{parentName:"pre",className:"language-sh"},"npx dbux run ../node_modules/webpack-cli/bin/cli.js -- webpack args here\n# or, if you want to debug webpack itself:\nnpx dbux run --pw=webpack.*,tapable,graceful-fs,enhanced-resolve ../node_modules/webpack-cli/bin/cli.js -- webpack args here\n")),(0,l.kt)("p",null,"Keep an eye out for the following pitfalls:"),(0,l.kt)("ol",null,(0,l.kt)("li",{parentName:"ol"},(0,l.kt)("inlineCode",{parentName:"li"},"webpack")," adds a layer of ",(0,l.kt)("inlineCode",{parentName:"li"},"@babel/register"),".",(0,l.kt)("ul",{parentName:"li"},(0,l.kt)("li",{parentName:"ul"},"Because of that: webpack will run itself with the default babel config of the project. That usually does not affect anything, but there are buggy edge cases, and that's worth noting."),(0,l.kt)("li",{parentName:"ul"},"Also, if you run that ",(0,l.kt)("inlineCode",{parentName:"li"},"webpack")," project with Dbux enabled, Dbux adds a second layer of ",(0,l.kt)("inlineCode",{parentName:"li"},"@babel/register"),". So it will double up. That is generally not a problem, but attentions is warranted.",(0,l.kt)("ul",{parentName:"li"},(0,l.kt)("li",{parentName:"ul"},"You want to make sure that ",(0,l.kt)("inlineCode",{parentName:"li"},"webpack")," itself does not read a ",(0,l.kt)("inlineCode",{parentName:"li"},"babel")," config which in turn adds ",(0,l.kt)("inlineCode",{parentName:"li"},"@dbux/babel-plugin")," (which the project default babel config is likely to do)."),(0,l.kt)("li",{parentName:"ul"},"NOTE: If you don't run ",(0,l.kt)("inlineCode",{parentName:"li"},"webpack")," with Dbux enabled, it is all fine."))))),(0,l.kt)("li",{parentName:"ol"},(0,l.kt)("inlineCode",{parentName:"li"},"webpack")," uses few libraries that themselves are very heavy on instrumentation. Since Dbux also instruments things, you end up having one instrumenter trying to instrument another. That can lead to problems.",(0,l.kt)("ul",{parentName:"li"},(0,l.kt)("li",{parentName:"ul"},"If you want to understand the inner workings of ",(0,l.kt)("inlineCode",{parentName:"li"},"webpack"),", we found the following whitelist to work quite well: ",(0,l.kt)("inlineCode",{parentName:"li"},"--pw=webpack.*,tapable,graceful-fs,enhanced-resolve"))))),(0,l.kt)("h2",{id:"rollup"},"Rollup"),(0,l.kt)("p",null,"TODO: We have not tested this in a while. Need to verify and set it in stone. Test with the previously working ",(0,l.kt)("inlineCode",{parentName:"p"},"Chart.js")," practice exercises (which uses Rollup)."),(0,l.kt)("p",null,"Rollup requires use of ",(0,l.kt)("a",{parentName:"p",href:"https://www.npmjs.com/package/@rollup/plugin-babel"},"@rollup/plugin-babel"),"."),(0,l.kt)("p",null,"Example - something like this:"),(0,l.kt)("pre",null,(0,l.kt)("code",{parentName:"pre",className:"language-js"},"const makeInclude = require('@dbux/common-node/dist/filters/makeInclude').default;\n\nconst moduleFilterOptions = {\n  packageWhitelist: 'interestingPackage1,@interesting/package2',\n  // packageBlacklist: '',\n  fileBlacklist: '.*bad_file1\\.js,.*/unwanted_dir1/.*'\n};\n\nconst config = {\n  ...\n  plugins: [\n    babel({\n      babelHelpers: 'inline',\n      filter: makeInclude(moduleFilterOptions),\n      /**\n       * WARNING: if not skipped, we saw some serious memory leaks (in 2020), but might already be fixed in 2022.\n       * TODO: we need to test this again.\n       */\n      skipPreflightCheck: true\n    })\n  ]\n};\n")),(0,l.kt)("h2",{id:"storybook"},"Storybook"),(0,l.kt)("p",null,"TODO"),(0,l.kt)("h2",{id:"create-react-app"},"Create-React-App"),(0,l.kt)("p",null,"TODO: Clean this up"),(0,l.kt)("ol",null,(0,l.kt)("li",{parentName:"ol"},(0,l.kt)("p",{parentName:"li"},"install ",(0,l.kt)("inlineCode",{parentName:"p"},"CRACO")),(0,l.kt)("pre",{parentName:"li"},(0,l.kt)("code",{parentName:"pre",className:"language-bash"},"$ yarn add --dev @craco/craco\n"))),(0,l.kt)("li",{parentName:"ol"},(0,l.kt)("p",{parentName:"li"},"Fix ",(0,l.kt)("inlineCode",{parentName:"p"},"package.json")," to use ",(0,l.kt)("inlineCode",{parentName:"p"},"craco")," instead of ",(0,l.kt)("inlineCode",{parentName:"p"},"react-scripts"),":"),(0,l.kt)("pre",{parentName:"li"},(0,l.kt)("code",{parentName:"pre"},'/* package.json */\n\n"scripts": {\n  "start": "craco start",\n  "build": "craco build",\n  "test": "craco test"\n}\n'))),(0,l.kt)("li",{parentName:"ol"},(0,l.kt)("p",{parentName:"li"},"Customize webpack config with ",(0,l.kt)("inlineCode",{parentName:"p"},"CRACO"),":\nExample - something like this:"),(0,l.kt)("pre",{parentName:"li"},(0,l.kt)("code",{parentName:"pre",className:"language-js"},"// craco.config.js\n\nconst { getLoaders, loaderByName } = require('@craco/craco');\n\nconst dbuxOptions = {\n  moduleFilter: {\n    packageWhitelist: '.*',\n    /**\n     * NOTE: these libraries might run before dbux is initialized, so they must be blacklisted.\n     * 1. Some hook themsleves into webpack.\n     * 2. The later ones are polyfills (probably brought in by CRA) and their libraries; loaded when first requiring things,    and before `@dbux/runtime`.\n     */\n    packageBlacklist: 'react-dev-utils,react-refresh,react-error-overlay,process,buffer,isarray,ieee754,base64-js',\n    fileWhitelist: '.*',\n    // we generally do not want to mess with production or webpack code\n    fileBlacklist: '.*production.*,.*[wW]ebpack.*'\n  }\n};\n\nmodule.exports = {\n  webpack: {\n    configure: (webpackConfig, { env, paths }) => {\n      const { hasFoundAny, matches } = getLoaders(webpackConfig, loaderByName(\"babel-loader\"));\n\n\n      // // TODO: write output files (this won't work, `devServer` does not exit)\n      // webpackConfig.devServer.devMiddleware.writeToDisk = true;\n\n      // // exclude dbux from all rules\n      // const reported = new Set();\n      // webpackConfig.module.rules.forEach(rule => {\n      //   if (rule.exclude && !Array.isArray(rule.exclude)) {\n      //     rule.exclude = [rule.exclude];\n      //   }\n      //   if (!rule.exclude) {\n      //     rule.exclude = [];\n      //   }\n      //   rule.exclude.push((modulePath) => {\n      //     const exclude = modulePath.includes('@dbux');\n      //     if (!reported.has(modulePath)) {\n      //       reported.add(modulePath);\n      //       console.debug(`[WEBPACK]`, modulePath, !exclude);\n      //     }\n      //     return exclude;\n      //   });\n      // });\n\n      // add dbux to loader\n      if (hasFoundAny) {\n        matches.forEach(match => {\n          const babelOptions = match.loader.options;\n          if (!babelOptions.plugins) {\n            babelOptions.plugins = [];\n          }\n          // NOTE: weird bug with a class having public fields (in @dbux/runtime) that Babel complains about\n          babelOptions.plugins.push(['@babel/plugin-proposal-class-properties', { loose: true }]);\n          babelOptions.plugins.push(['@dbux/babel-plugin', dbuxOptions]);\n        });\n        console.debug(`Added @dbux/babel-plugin to babel-loaders.`);\n      }\n      else {\n        throw new Error(`Could not inject Dbux: 'babel-loader' found`);\n      }\n\n      return webpackConfig;\n    }\n  },\n};\n")))),(0,l.kt)("h2",{id:"nextjs"},"Next.js"),(0,l.kt)("p",null,"TODO"),(0,l.kt)("h2",{id:"ng"},"ng"),(0,l.kt)("p",null,"TODO"),(0,l.kt)("h2",{id:"other-bundlers-or-bundler-wrappers"},"Other Bundlers or Bundler Wrappers"),(0,l.kt)("p",null,"TODO"))}k.isMDXComponent=!0}}]);